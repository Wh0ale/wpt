<html>
<title>WorkletAnimation should continue to be in effect forever, even if its duration is passed</title>
<link rel="help" href="https://drafts.css-houdini.org/css-animationworklet/">
<link rel="match" href="worklet-animation-duration-ref.html">

<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script src="/web-animations/testcommon.js"></script>
<script src="common.js"></script>

<div id="box"></div>

<script>
  promise_test(async t => {
    await registerConstantLocalTimeAnimator(0.5);

    const box = document.getElementById('box');
    const effect = new KeyframeEffect(box,
      [
        {transform: 'translateY(0px)' },
        {transform: 'translateY(200px)' }
      ], {
        duration: 1,
      }
    );

    const animation = new WorkletAnimation('constant_time', effect);
    animation.play();

    // The animation is specified to last for 1 millisecond, but we wait for 500ms
    // to be safe. This is definitely risking flake, but until we start forwarding
    // style changes to the main thread there's not much else we can do here.
    await new Promise(resolve => step_timeout(resolve, 500));

    // Note that this is only required in the case where this test would *fail*.
    // We want to be sure we spot the WorkletAnimation incorrectly ending early,
    // so we need to force a redraw.
    let expected_transform = "matrix(1, 0, 0, 1, 0, 100)";
    await waitForAnimationFrameWithCondition(_ => {
      return getComputedStyle(box).transform == expected_transform;
    });
    assert_equals(getComputedStyle(document.getElementById("box")).transform, expected_transform);
  }, "WorkletAnimation should continue to be in effect forever, even if its duration is passed");
</script>
